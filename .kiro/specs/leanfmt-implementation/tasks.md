# Implementation Plan

- [x] 1. 構文解析アダプタの整備
  - Lean 4 パーサを使って入力ソースを解析し、入力単位で AST を生成できるようにする
  - 解析失敗は原因が分かる形で上位へ伝播する
  - 入力ごとの整形結果が構文的に有効となる前提で、未対応構文は明確に失敗として扱う
  - _Requirements: 3.3, 4.1_

- [x] 2. 整形エンジンの規則と出力保証
- [x] 2.1 AST の主要構文要素を決定的な規則で整形できるようにする
  - 主要コマンド/式/型の整形結果が入力ごとに一貫するように揃える
  - 整形結果が Lean 4 の構文として有効になることを担保する
  - _Requirements: 3.1, 3.3_

- [x] 2.2 冪等性と末尾改行の正規化を保証する
  - 整形済み入力の再整形で同一出力になるように調整する
  - 出力末尾の改行を一貫した規則で正規化する
  - _Requirements: 3.2_

- [x] 3. (P) CLI オプション解析と入力指定の検証
  - check / in-place / stdout の競合を検出し、競合時は明確に失敗させる
  - 未知オプションや無効な組み合わせを検出し、CLI へ理由を渡せるようにする
  - `-` を stdin 指定として扱い、複数指定や `--in-place` との併用を無効として扱う
  - in-place でファイル未指定の場合は失敗として扱う
  - 入力指定の順序を保持して CLI ランナーに渡せるようにする
  - _Requirements: 1.5, 2.4, 4.3_

- [x] 4. CLI ランナーの入力取得と出力モード
- [x] 4.1 入力ソースの解決と読み取り
  - 引数なし時は stdin を入力として読み取る
  - ファイル指定と stdin 指定 (`-`) を指定順に処理する
  - 入力の読み込み失敗や存在しないパスを検知し、失敗として扱う
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 4.2 モード別の出力処理と check 判定
  - stdout / in-place / check の各モードで整形結果の出力・上書き・一致判定を実行する
  - check モードでファイル未指定の場合は stdin を読み取り、TTY でも入力待機して判定する
  - stdout で複数ファイル時はファイル名ヘッダと空行を出力し、単一ファイル/ stdin では出力しない
  - 複数入力を stdout に連結する際は各入力を独立に整形し、連結結果の構文有効性は保証対象外とする
  - 不一致が 1 件でもあれば失敗終了、全件一致なら成功終了とする
  - _Requirements: 2.1, 2.2, 2.3, 2.5, 2.6, 2.7, 3.4, 5.1, 5.2_

- [x] 4.3 失敗診断と終了コードの一貫化
  - 構文解析失敗や整形失敗を標準エラーへ明確に出力する
  - 書き込み失敗や無効オプション時に原因と使用方法を提示する
  - 失敗時は一律で非成功の終了コードを返す
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 5. テストとゴールデンケースの整備
- [x] 5.1 ユニットテストでオプション検証と整形の決定性を確認する
  - モード競合、未知オプション、`-` 複数指定の検証結果を確認する
  - 整形結果の決定性と末尾改行の正規化を検証する
  - _Requirements: 1.5, 2.4, 3.1, 3.2, 4.3_

- [x] 5.2 統合テストで入出力分岐と check 判定を確認する
  - ファイル入力/標準入力/引数なしの分岐を検証する
  - stdout / in-place / check の動作と終了コードを検証する
  - 複数ファイル stdout のヘッダ出力と stdin の扱いを検証する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.5, 2.6, 2.7, 5.1, 5.2_

- [x] 5.3 E2E/ゴールデンテストで冪等性と自己整形を確認する
  - 入力/出力のゴールデンケースで整形結果の冪等性を検証する
  - 標準構文のケースを含め、入力ごとの構文的有効性を確認する
  - leanfmt 自身のソースを対象に `leanfmt Main.lean Leanfmt.lean Leanfmt/**/*.lean` が成功することを確認する
  - 自己整形の出力が元のソースと同じ意味になることを確認する
  - 自己整形の出力が正しく整形されていることを確認する
  - _Requirements: 3.2, 3.3, 3.5_
